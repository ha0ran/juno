<!DOCTYPE html>
<html>
    <head>
        <title>JUNO Editor</title>
        <link href="assets/css/bootstrap.min.css" rel="stylesheet">
        <link href="assets/css/editor.css" rel="stylesheet">
        <link href="assets/css/fonts.css" rel="stylesheet">
        <link href="assets/css/juno.css" rel="stylesheet">
    </head>
    <body>
    	<div class="navbar">
            <div class="navbar-inner">
                <a class="brand" href="#">Juno</a> 
                <ul class="nav">
                    <li><a href="#home-pane" id="home-tab" data-toggle="tab">HOME</a></li> 
                    <li class="active"><a href="#archive-pane" id="archive-tab" data-toggle="tab">ARCHIVE</a></li>
                    <li><a href="#about-pane" id="about-tab" data-toggle="tab">ABOUT</a></li>
                    <li><a href="#new-pane" id="new-tab" data-toggle="tab">New</a></li>
                    <li><a href="#admin-pane" id="admin-tab" data-toggle="tab">Admin</a></li>
                    <li><a href="#editor-pane" id="edit-tab" data-toggle="tab">Editor</a></li>
                </ul> 
            </div>
        </div>
        <div class="tab-content">
            <div class="tab-pane" id="about-pane">
            </div>
            <div class="tab-pane" id="home-pane"> 
                <div class="container">
                    <div id="entries">
                    </div>
                </div>
            </div>
            <div class="tab-pane active" id="archive-pane">
                <div class="container">
                    <div id="archive-entries">
                    </div>
                </div>
            </div>
            <div class="tab-pane" id="new-pane">
            </div>
            <div class="tab-pane" id="post-pane">
                <div class="container-fluid" id="content">
                </div>
            </div>
            <div class="tab-pane" id="admin-pane">
                <div class="container">
                    <div id="admin-entries">
                    </div>
                </div>
            </div>
            <div class="tab-pane" id="editor-pane">
            </div>
        </div>
        <script id="editor-template" type="text/template"> 
            <input type="text" id="title" class="span12" placeholder="title of the article" value="<%= title %>"/>
            <div class="row-fluid">
                <div class="span6">
                    <textarea id="content"><%= content %></textarea>
                </div>
                <div id="preview" class="span6">
                </div>
            </div>
            <div class="btn-group">
                <a class="btn" onclick="preview();">Preview</a>
                <button class="btn btn-primary btn-submit">Submit</button>
            </div>
        </script>
        <script id="logo-template" type="text/template"> 
            <div class="large-logo">Juno</div>
        </script>
        <script id="post-summary-template" type="text/template"> 
                <a class="title" data-id="<%= id %>"><h1 class="article-title"><%= title %></h1></a>
                <time> <%= lastModifiedAt %> </time>
        </script>
        <script id="admin-summary-template" type="text/template"> 
                <a class="title" data-id="<%= id %>"><h1 class="article-title"><%= title %></h1></a>
                <time> <%= lastModifiedAt %> </time>
                <button class="btn btn-primary btn-edit" type="button">Edit</button>
                <button class="btn btn-danger btn-delete" type="button">Delete</button>
        </script>
        <script id="entry-template" type="text/template">
            <header>
                <p><time> <%= lastModifiedAt %> </time></p>
                <h1 class="article-title"><a class="title" data-id="<%= id %>"><%= title %></a></h1>
            </header>
            <div class="article-content"><%= Markdown(content) %></div>
        </script>
        <script id="post-template" type="text/template">
            <header>
                <p><time> <%= lastModifiedAt %> </time></p>
                <h1 class="article-title"><a class="title" data-id="<%= id %>"><%= title %></a></h1>
            </header>
            <div class="article-content"><%= Markdown(content) %></div>
        </script>
        <script id="pagination-template" type="text/template">
            <% if (pageCount > 0) { %>
            <ul class="pager">
                <% if (currentPage > 1) { %>
                <li class="next">
                    <a href="#" class="pagination-item" data-page="<%= currentPage - 1 %>">Newer &rarr;</a>
                </li>
                <% } %>
                <% if (currentPage < pageCount ) { %>
                <li class="previous">
                    <a href="#" class="pagination-item" data-page="<%= currentPage + 1 %>">&larr; Older</a>
                </li>
                <% } %>
            </ul>
            <% } %>
        </script>
        <script type="text/javascript" src="lib/jquery-2.0.2.js"></script>
        <script type="text/javascript" src="lib/underscore.js"></script>
        <script type="text/javascript" src="lib/backbone.js"></script>
        <script type="text/javascript" src="lib/bootstrap.js"></script>
        <!-- Maybe consider use pagedown extra after investigation -->
        <script type="text/javascript" src="lib/js-markdown-extra.js"></script>
        <script type="text/javascript">
            $('#editor').on("input change",function(){
                preview();
            });
            function preview(){
                $('#preview').html(Markdown($('#editor').val()));
            }
            function submit(){
                if ($("#title").val() === '') {
                    alert("Please input article title");
                    return;
                }
                if ($("#editor").val() === '') {
                    alert("Please input article content");
                    return;
                }
                $.post( '/api/posts', {
                        'title': $("#title").val(),
                        'content': $("#editor").val()
                    }, 
                    function(data, textStatus, jqXHR) { 
                        console.log( 'Post response:' ); 
                        console.dir( data );
                        console.log( textStatus ); 
                        console.dir( jqXHR );
                    }
                );
                $("#title").val('');
                $("#editor").val('');
                $('#preview').html('');
            }
            $(document).ready(function() {
                jQuery.event.props.push('dataTransfer');
                $('#editor').bind('drop', function(evt) {
                    var files = evt.dataTransfer.files;
                    $.each(files, function(index, file) {
                        if (!file.type.match('image.*')) {
                            alert("Sorry, but we only support images now!");
                            //Display Error Message 
                        }
                        var fileReader = new FileReader();
                        fileReader.onload = (function(file) {
                            return function(e) { 
                                $.post('/upload', {name: file.name, content: e.target.result}, function(data) {
                                    var result = $.parseJSON(data);
                                    $("#editor").val($("#editor").val() + " !["+ file.name + "](" + result.url + ") ");
                                    $("#editor").change();
                                });
                            }
                        })(file);
                        fileReader.readAsDataURL(file);
                    });
                    return false;
                });
            });
        </script>
        <script type="text/javascript">
            /* for Backbone script */
            /* Ref: http://stackoverflow.com/questions/9713246/backbone-js-unable-to-trigger-custom-view-from-parent-view-and-have-child-view */
            Backbone.View.prototype.eventHub = _.extend({}, Backbone.Events);
            var app = app || {};
            app.Post = Backbone.Model.extend({
                urlRoot: '/api/posts',
                defaults: {
                    title: '',
                    content: '',
                    lastModifiedAt: '1970-01-01'
                },
                parse: function( response ) { 
                    response.id = response._id; 
                    return response;
                }
            });
            var app = app || {};
            app.Archive = Backbone.Collection.extend({
                model: app.Post,
                url: '/api/posts',
                parse: function(data) {
                    if (!data) {
                        this.total = 0;
                        return []; 
                    }
                    this.total = data.total;
                    return data.posts;
                },
            });
            var app = app || {};
            /* TODO Need to create a abstract PostEntry for Home/Archive/Admin custom by params */
            app.PostSummaryView = Backbone.View.extend({
                tagName: 'article',
                template: _.template( $('#post-summary-template').html() ),
                events: {
                    "click a.title": "fetchPost"
                },
                initialize: function() {
                    //this.model = options.model;
                    // make sure 'this' refers to this View in the success callback below
                    _.bindAll(this, "renderPostView"); 
                },
                render: function() {
                    // tmpl is a function that takes a JSON object and returns html
                    // this.el is what we defined in tagName. use $el to get access // to jQuery html() function
                    this.$el.html( this.template( this.model.toJSON() ));
                    return this; 
                },
                fetchPost: function (event){
                    this.model.fetch({success: this.renderPostView});
                },
                renderPostView: function(){
                    var postView = new app.PostView({
                        model: this.model
                    });
                    $(".tab-pane.active").removeClass("active");
                    $(".nav li.active").removeClass("active")
                    $("#post-pane.tab-pane").addClass("active");
                    $("#post-pane #content").html( postView.render().el );

                }
            });
            app.AdminSummaryView = Backbone.View.extend({
                tagName: 'article',
                template: _.template( $('#admin-summary-template').html() ),
                events: {
                    "click a.title": "fetchPost",
                    "click button.btn-edit": "edit",
                    "click button.btn-delete": "drop"
                },
                initialize: function() {
                    //this.model = options.model;
                    // make sure 'this' refers to this View in the success callback below
                    _.bindAll(this, "renderPostView"); 
                },
                render: function() {
                    // tmpl is a function that takes a JSON object and returns html
                    // this.el is what we defined in tagName. use $el to get access // to jQuery html() function
                    this.$el.html( this.template( this.model.toJSON() ));
                    return this; 
                },
                fetchPost: function (event){
                    this.model.fetch({success: this.renderPostView});
                },
                renderPostView: function(){
                    var postView = new app.PostView({
                        model: this.model
                    });
                    $(".tab-pane.active").removeClass("active");
                    $(".nav li.active").removeClass("active")
                    $("#post-pane.tab-pane").addClass("active");
                    $("#post-pane #content").html( postView.render().el );
                },
                edit: function() {
                    console.log("Edit post");
                    var editorView = new app.EditorView({
                        model: this.model
                    });
                    $(".tab-pane.active").removeClass("active");
                    $(".nav li.active").removeClass("active")
                    $("#editor-pane.tab-pane").addClass("active");
                    $("#editor-pane").html( editorView.render().el );
                },
                drop: function(){
                    this.model.destroy();
                    this.remove();
                }
            });
            app.EntryView = Backbone.View.extend({
                tagName: 'article',
                template: _.template( $('#entry-template').html() ),
                render: function() {
                    // tmpl is a function that takes a JSON object and returns html
                    // this.el is what we defined in tagName. use $el to get access // to jQuery html() function
                    this.$el.html( this.template( this.model.toJSON() ));
                    return this; 
                }
            });
            app.EditorView = Backbone.View.extend({
                tagName: 'div',
                template: _.template( $('#editor-template').html() ),
                events: {
                    "click button.btn-submit": "submit"
                },
                render: function() {
                    // tmpl is a function that takes a JSON object and returns html
                    // this.el is what we defined in tagName. use $el to get access // to jQuery html() function
                    this.$el.html( this.template( this.model.toJSON() ));
                    return this; 
                },
                submit: function(evt){
                    evt.preventDefault();
                    this.model.save({
                        'title': this.$el.find('#title').val(),
                        'content': this.$el.find('#content').val()
                    });
                }
            });
            app.PostView = Backbone.View.extend({
                tagName: 'div',
                template: _.template( $('#post-template').html() ),
                render: function() {
                    // tmpl is a function that takes a JSON object and returns html
                    // this.el is what we defined in tagName. use $el to get access // to jQuery html() function
                    this.$el.html( this.template( this.model.toJSON() ));
                    return this; 
                }
            });
            app.PaginationView = Backbone.View.extend({
                tagName: 'div',
                //className: "pagination",
                template: _.template( $('#pagination-template').html() ),
                events: {
                    "click .pagination-item": "jumpToPage"
                },
                initialize: function(options) {
                    this.currentPage = options.currentPage;
                    this.pageCount = options.pageCount;
                },
                render: function() {
                    this.$el.append( this.template( {currentPage: this.currentPage, pageCount: this.pageCount} ));    
                    return this; 
                },
                jumpToPage: function( event ) {
                    var page = $(event.currentTarget).data("page");
                    this.eventHub.trigger('changePage', page);
                }
            });
            var app = app || {};
            app.ArchiveView = Backbone.View.extend({
                el: '#archive-pane #archive-entries',
                initialize: function() {
                    this.collection = new app.Archive(); 
                    this.collection.fetch({reset: true});
                    this.render();
                    this.listenTo( this.collection, 'add', this.render );
                    this.listenTo( this.collection, 'reset', this.render );
                },
                // render library by rendering each book in its collection
                render: function() { 
                    this.$el.html('');
                    if(this.collection.length === 0) {
                        this.renderLogo();
                        return;
                    } else {
                        this.collection.each(function( item ) {
                            this.renderSummaryEntry( item ); 
                        }, this );
                    }
                },
                renderLogo: function() {
                    this.$el.append(_.template($('#logo-template').html()));
                },
                // render a book by creating a BookView and appending the 
                // element it renders to the library's element 
                renderSummaryEntry: function( item ) {
                    var postSummaryView = new app.PostSummaryView({
                        model: item
                    });
                    this.$el.append( postSummaryView.render().el ); 
                }
            });
            app.AdminView = Backbone.View.extend({
                el: '#admin-pane #admin-entries',
                initialize: function() {
                    this.collection = new app.Archive(); 
                    this.collection.fetch({reset: true});
                    this.render();
                    this.listenTo( this.collection, 'add', this.render );
                    this.listenTo( this.collection, 'reset', this.render );
                },
                // render library by rendering each book in its collection
                render: function() { 
                    this.$el.html('');
                    if(this.collection.length === 0) {
                        this.renderLogo();
                        return;
                    } else {
                        this.collection.each(function( item ) {
                            this.renderSummaryEntry( item ); 
                        }, this );
                    }
                },
                renderLogo: function() {
                    this.$el.append(_.template($('#logo-template').html()));
                },
                // render a book by creating a BookView and appending the 
                // element it renders to the library's element 
                renderSummaryEntry: function( item ) {
                    var postSummaryView = new app.AdminSummaryView({
                        model: item
                    });
                    this.$el.append( postSummaryView.render().el ); 
                }
            });
            var app = app || {};
            app.HomeView = Backbone.View.extend({
                el: '#home-pane #entries',
                initialize: function() {
                    this.collection = new app.Archive();
                    this.itemsPerPage = 3;
                    this.currentPage = 1;
                    this.updateCollection();
                    this.render();
                    this.listenTo( this.collection, 'add', this.render );
                    this.listenTo( this.collection, 'reset', this.render );
                    this.eventHub.bind('changePage', this.jumpToPage, this);
                },
                updateCollection: function() {
                    this.collection.fetch({reset: true, data: $.param({page: this.currentPage, limit: this.itemsPerPage})});
                }, 
                // render library by rendering each book in its collection
                render: function() { 
                    /* Need to improve, it's not a good idea to remove all elements
                       Maybe consider to display a logon or text on the background
                    */
                    this.$el.html('');
                    if(this.collection.length === 0) {
                        this.renderLogo();
                        return;
                    } else {
                        this.collection.each(function( item ) {
                            this.renderEntry( item ); 
                        }, this );
                    }
                    var pageCount = Math.ceil(this.collection.total / this.itemsPerPage )
                    this.renderPagination( pageCount );
                },
                renderLogo: function() {
                    this.$el.append(_.template($('#logo-template').html()));
                },
                // render a book by creating a BookView and appending the 
                // element it renders to the library's element 
                renderEntry: function( item ) {
                    var postView = new app.EntryView({
                        model: item
                    });
                    this.$el.append( postView.render().el ); 
                },
                renderPagination: function(pageCount) {
                    var paginationView = new app.PaginationView({
                        pageCount: pageCount,
                        currentPage: this.currentPage
                    });
                    this.$el.append( paginationView.render().el );
                },
                jumpToPage: function(page) {
                    this.currentPage = page;
                    this.updateCollection();
                }
            });
            new app.HomeView();
            new app.ArchiveView();
            new app.AdminView();
        </script>
    </body>
</html>
